#!/bin/bash
# it-scan - Infrastructure & Network Inventory Tool
# Ver: 2.0 | Repository: https://github.com/njvdh/it-scan

# --- Configuration ---
LINUX_HOSTS="10.0.0.10 10.0.0.11 10.0.0.12 10.0.0.15 10.0.0.17"
APS="10.0.1.2 10.0.1.3 10.0.1.4 10.0.1.5 10.0.1.6 10.0.1.7"
SNMP_COMMUNITY="public"

inventory_task() {
    echo "=========================================================="
    echo " HOST: $(hostname -f) | IP: $(hostname -I | awk '{print $1}')"
    echo "=========================================================="
    uptime -p

    # Storage Check
    echo "--- Storage ---"
    df -h | grep -E '^/dev/|^rpool|^HDD'

    # Proxmox/ZFS Check
    if command -v qm >/dev/null 2>&1; then
        echo "--- Proxmox VMs ---"
        qm list | grep "running" || echo "No active VMs"
        echo "--- ZFS Pools ---"
        zpool list -H | awk '{print $1 " -> " $10}'
    fi

    # Incus Check
    if command -v incus >/dev/null 2>&1; then
        echo "--- Incus Containers ---"
        incus list --columns ns4 --format csv | sed 's/,/ -> /'
    fi
}

scan_wifi() {
    echo "=== RUCKUS WIFI STATUS (SNMP) ==="
    for ap in $APS; do
        # Get System Name
        NAME=$(snmpget -v2c -c "$SNMP_COMMUNITY" "$ap" .1.3.6.1.2.1.1.5.0 -Oqv 2>/dev/null | tr -d '"')
        
        if [ -z "$NAME" ]; then
            echo "AP $ap | OFFLINE or SNMP Timeout"
            continue
        fi

        # Try New Ruckus OID (R350/R550 series)
        CLIENTS=$(snmpget -v2c -c "$SNMP_COMMUNITY" "$ap" .1.3.6.1.4.1.25053.1.15.1.1.1.15.13.0 -Oqv 2>/dev/null)

        # Fallback to Old Ruckus OID (Older ZoneFlex)
        if [[ -z "$CLIENTS" || "$CLIENTS" == "No Such Object"* ]]; then
            CLIENTS=$(snmpget -v2c -c "$SNMP_COMMUNITY" "$ap" .1.3.6.1.4.1.25053.1.1.1.1.1.1.1.14 -Oqv 2>/dev/null)
        fi

        # Cleanup output
        if [[ "$CLIENTS" == "No Such Object"* || -z "$CLIENTS" ]]; then
            CLIENTS="0"
        fi

        echo "AP $ap | $NAME | Clients: $CLIENTS"
    done
}

# Main Logic
case "$1" in
    wifi)
        scan_wifi
        ;;
    linux)
        for target in $LINUX_HOSTS; do
            ssh -q -t -o ConnectTimeout=2 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$target "$(declare -f inventory_task); inventory_task"
        done
        ;;
    all|*)
        if [ "$1" == "all" ]; then
            $0 linux
            $0 wifi
        else
            echo "Usage: $0 {linux|wifi|all}"
            exit 1
        fi
        ;;
esac
